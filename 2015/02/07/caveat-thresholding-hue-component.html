<!DOCTYPE html>
<html>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58227951-1', 'http://hanzratech.in');
  ga('send', 'pageview');

</script>


  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>CAVEAT!! - Thresholding Hue Component</title>
    <meta name="description" content="Computer Vision and Programming blog
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bikz05.github.io/2015/02/07/caveat-thresholding-hue-component.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <!-- <a class="site-title" href="/">Hanzra Tech</a> -->
    <a class="site-title" href="/"><img src="/assets/logo/hanzratech-logo.png" alt="Hanzra Tech" style="width:144px;height:50px"></a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/contact/">Contact</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "e95f9855-8c25-452f-a5aa-52401715f9e1", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <h1 class="post-title">CAVEAT!! - Thresholding Hue Component</h1>
    <p class="post-meta">Feb 7, 2015 • Bikramjot Singh Hanzra</p>
  </header>

  <article class="post-content">
    <p>There are times when we unwittingly commit the same mistake incessantly without actually discovering the reason behind it because we never fathom that something of that sort can actually happen. One of the first hands-on application that fledgling Computer Vision enthusiasts start with is color detection. In color detection, we find the pixel locations whose values match our desired color values (and yes, OpenCV function <a href="http://docs.opencv.org/modules/core/doc/operations_on_arrays.html#cv2.inRange"><code>cv2.inRange</code></a> performs this task). In this tutorial, I will discuss about one of the many mistake that most newbies make. I did commit this peccadillo for a long time before I could figure it out. <em>Making mistakes is not a mistake, but not correcting them is definitely.</em> The philosopher in me, sometimes overpowers the engineer in me. Leaving me aside, in this blog post we will try to detect the Manchester United jersey in the image below using color detection and while doing so we will discover some absurd results. I have chosen the red jersey intentionally and you will figure it out why I did so as we go through this tutorial.</p>

<figure id="figure-1"><a href="/figures/manu.jpg"><img src="/figures/manu.jpg" alt="In this image, we will detect the red pixels" /></a><figcaption>Figure 1: In this image, we will detect the red pixels [<a href="/figures/manu.jpg">JPG</a>]</figcaption></figure>

<p>As you can notice, the jersey is predominantly red, so we will set the cv2.inrange function with the range of RGB values of red color. The code snippet below performs this task -</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;manu.jpg&quot;</span><span class="p">)</span>
<span class="lineno">2</span> <span class="n">im_red_ball_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
<span class="lineno">3</span> <span class="n">im_red_ball_mask</span> <span class="o">=</span> <span class="n">im_red_ball_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
<span class="lineno">4</span> <span class="n">myShow</span><span class="p">(</span><span class="s">&quot;Resulting image with RGB values within (30-255, 0-80, 0-80)&quot;</span><span class="p">,</span> <span class="n">im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">im_red_ball_mask</span><span class="p">,</span> <span class="n">im_red_ball_mask</span><span class="p">,</span> <span class="n">im_red_ball_mask</span><span class="p">)))</span></code></pre></div>

<p>In <strong>line 1</strong>, we read the image.The RGB value of true RED color is (255, 0, 0) but in real world images there is always variations in the image color values due to various lightening conditions, shadows and, even due to noise added by the camera while clicking and subsequently processing the image. So, in <strong>line 2</strong> we set the range of red color values as (30-255, 0-80, 0-80). Any pixel value that lies in between these values is labelled as a red pixel in the output mask <code>im_red_ball_mask</code>. The mask values are either 255 or 0. 255 represents the red color pixels and 0 represents the pixels that are not red. In <strong>line 3</strong>, we change the data type of the mask to <strong>boolean</strong> as it will help us in displaying the image. Finally, in <strong>line 4</strong>, we display the image using the function named myshow. The myshow function is similar to <code>cv2.imshow</code> function. Since, I write code in IPython notebooks, I developed my custom display function as the usual <code>cv2.imshow</code> function does not work in IPython Notebooks. You can replace it by <code>cv2.imshow</code>, if you are not working in IPython Notebook. This is how the resulting image looks like -</p>

<figure id="figure-2"><a href="/figures/manu-rgb.png"><img src="/figures/manu-rgb.png" alt="Resulting image after applying the inrange function to get Red Pixel. If look meticulously, you will notice that there are some white pixels that have been incorrectly classified as RGB pixels." /></a><figcaption>Figure 2: Resulting image after applying the inrange function to get Red Pixel. If look meticulously, you will notice that there are some white pixels that have been incorrectly classified as RGB pixels. [<a href="/figures/manu-rgb.png">PNG</a>]</figcaption></figure>

<p>If you look meticulously, you will notice that there are some white pixels that have been incorrectly classified as red pixels. In order to remove these pixels, we will perform color detection in the HSV color space. Let’s convert the image into HSV color space using the <code>cv2.cvtColor</code> function.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">im_hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span></code></pre></div>

<p>The HSV values for true RED are (0, 255, 255) and to accommodate for variations as discussed above, we will consider a range of HSV values for the red color. So, we will use the <code>cv2.inRange</code> to generate the mask that has a value of 255 for pixels where the HSV values fall within the range (0-10, 100-255, 0-255)  and a value of 0 for pixels whose values don’t lie in this interval. The mask values are either 255 or 0. 255 represents red color pixels and 0 represents non red color pixels. We will again convert this mask into boolean type and will then display the image using <code>myShow</code> function.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">im_red_ball_mask_1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">im_hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
<span class="lineno">2</span> <span class="n">im_red_ball_mask_1</span> <span class="o">=</span> <span class="n">im_red_ball_mask_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
<span class="lineno">3</span> <span class="n">myShow</span><span class="p">(</span><span class="s">&quot;Resulting image with Hue values within 0-10&quot;</span><span class="p">,</span> <span class="n">im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">im_red_ball_mask_1</span><span class="p">,</span> <span class="n">im_red_ball_mask_1</span><span class="p">,</span> <span class="n">im_red_ball_mask_1</span><span class="p">)))</span></code></pre></div>

<figure id="figure-3"><a href="/figures/manu_mask_1.png"><img src="/figures/manu_mask_1.png" alt="Resulting image obtained using `cv2.inRange` function with HSV values in the range (0-10, 100-255, 0-255)" /></a><figcaption>Figure 3: Resulting image obtained using `cv2.inRange` function with HSV values in the range (0-10, 100-255, 0-255) [<a href="/figures/manu_mask_1.png">PNG</a>]</figcaption></figure>

<p>But what just happened!! Instead of improving, on the contrary our results deteriorated. The resulting image does not contains a major chunk of red pixels that were present in the previous image. The next thought that comes to mind is to tweak the HSV Values, but believe me that would not help. I am not being a pessimist here but there is an underlying idea that needs to be understood before trying anything new. The HSV color space unlike the RGB color space is a cylindrical color space (as shown in the image below). The Hue values are across a circle. So, after completing one rotation across the circle, we get the same color i.e. the Hue values at 0 and 360 (as shown in part <strong>B.</strong> of the image below) represent the same color which happens to be red. Just to avoid confusion w.r.t. to the diagram below – OpenCV uses HSV ranges between (0-180, 0-255, 0-255), and what you will find in most books and the diagram below is that the range of (0-360, 0-1, 0-1) is used to represent the entire gamut of HSV color space. So in OpenCV, the H values 179, 178, 177 and so on are as close to the true RED as H value 1, 2, 3 and so on.</p>

<figure id="figure-4"><a href="/figures/hsv_colorspace.jpg"><img src="/figures/hsv_colorspace.jpg" alt="HSV Color Space" /></a><figcaption>Figure 4: HSV Color Space [<a href="/figures/hsv_colorspace.jpg">JPG</a>]</figcaption></figure>

<p>So, I think you have grasped the concept quite well and by now, you would have guessed what we will do next. Yes, we will again use the <code>cv2.inRange</code> function but this time the range of Hue values will be between 170-180 instead of 0-10 used earlier. Here is the code for the new H range values -</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">im_red_ball_mask_2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">im_hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span> 
<span class="lineno">2</span> <span class="n">im_red_ball_mask_2</span> <span class="o">=</span> <span class="n">im_red_ball_mask_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;bool&#39;</span><span class="p">)</span>
<span class="lineno">3</span> <span class="n">myShow</span><span class="p">(</span><span class="s">&quot;Resulting image with Hue values within 170-180&quot;</span><span class="p">,</span> <span class="n">im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">im_red_ball_mask_2</span><span class="p">,</span> <span class="n">im_red_ball_mask_2</span><span class="p">,</span> <span class="n">im_red_ball_mask_2</span><span class="p">)))</span></code></pre></div>

<p>The resulting image looks like this -</p>

<figure id="figure-5"><a href="/figures/manu_mask_2.png"><img src="/figures/manu_mask_2.png" alt="Resulting image obtained using cv2.inRange function with HSV values in the range (170-180, 100-255, 0-255" /></a><figcaption>Figure 5: Resulting image obtained using cv2.inRange function with HSV values in the range (170-180, 100-255, 0-255 [<a href="/figures/manu_mask_2.png">PNG</a>]</figcaption></figure>

<p>That’s it, we have successfully recovered our missing red color pixels by using the new Hue values and have also negated the white noise pixels that we had while working with the RGB color space. Now, just for the sake of aesthetics, we will combine both the masks and then we will display the final image.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">im_red_ball_mask_full</span> <span class="o">=</span> <span class="n">im_red_ball_mask_1</span> <span class="o">+</span> <span class="n">im_red_ball_mask_2</span>
<span class="lineno">2</span> <span class="n">myShow</span><span class="p">(</span><span class="s">&quot;Resulting image by adding both the masks&quot;</span><span class="p">,</span> <span class="n">im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">im_red_ball_mask_full</span><span class="p">,</span> <span class="n">im_red_ball_mask_full</span><span class="p">,</span> <span class="n">im_red_ball_mask_full</span><span class="p">)))</span></code></pre></div>

<figure id="figure-6"><a href="/figures/manu_mask_full.png"><img src="/figures/manu_mask_full.png" alt="Resulting image after adding both the masks." /></a><figcaption>Figure 6: Resulting image after adding both the masks. [<a href="/figures/manu_mask_full.png">PNG</a>]</figcaption></figure>

<h3 id="recap">RECAP</h3>

<p>In this blog post, I showed you how an oversight while setting the Hue values for red color can fail your code. We also discussed how to correctly set the range for hue values for red color. You will need to keep this in mind while working with HSL color space also. I hope you liked this blog post.</p>

<p><em>Thank You</em></p>

<h3 id="code"><strong>CODE</strong></h3>

<ul>
  <li>You can test the code in the cloud by importing the <a href="https://cloud.sagemath.com/projects/04f23e0d-02c9-4862-a739-b02732339e18/files/">SageMath Cloud project</a>.</li>
  <li>You can also view the code using <a href="http://nbviewer.ipython.org/gist/bikz05/d352272ac69977f22560">nbviewer</a>.</li>
</ul>


  </article>
  
  <center>
<span class='st__large' displayText=''></span>
<span class='st_facebook_large' displayText='Facebook'></span>
<span class='st_googleplus_large' displayText='Google +'></span>
<span class='st_twitter_large' displayText='Tweet'></span>
<span class='st_evernote_large' displayText='Evernote'></span>
<span class='st_tumblr_large' displayText='Tumblr'></span>
<span class='st_baidu_large' displayText='Baidu'></span>
<span class='st_linkedin_large' displayText='LinkedIn'></span>
<span class='st_pinterest_large' displayText='Pinterest'></span>
<span class='st_email_large' displayText='Email'></span>
</center>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hanzratech'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <!-- <h2 class="footer-heading">Hanzra Tech</h2> -->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
	<h3>Hanzra Tech</h3>
        <ul class="contact-list">
	  <li>Bikramjot Singh Hanzra</li>
          <li><a href="mailto:bikz.05@gmail.com">bikz.05@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2" style="text-align: center">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bikz05">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">bikz05</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/bikz05">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">bikz05</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
	<h3>Subscribe to our mailing list</h3>
	<!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/classic-081711.css" rel="stylesheet" type="text/css">
<style type="text/css">
	#mc_embed_signup{clear:left; font:14px Helvetica,Arial,sans-serif; }
	/* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="//hanzratech.us10.list-manage.com/subscribe/post?u=a52f12efb0d1b0d41d887206e&amp;id=647ba168eb" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<!-- <h2>Subscribe to our mailing list</h2> -->
<!-- <div class="indicates-required"><span class="asterisk">*</span> indicates required</div> -->
<div class="mc-field-group">
	<label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
</label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
</div>
	<div id="mce-responses" class="clear">
		<div class="response" id="mce-error-response" style="display:none"></div>
		<div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_a52f12efb0d1b0d41d887206e_647ba168eb" tabindex="-1" value=""></div>
    <div class="clear" ><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>
<script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<!--End mc_embed_signup-->

        <!-- <p class="text">Computer Vision and Programming blog
</p> -->
      </div>
    </div>

    <div style="text-align: center">
    Computer Vision and Programming Blog <br>
    Copyright &#169 2014 All rights reserved <a href="/">Hanzra Tech</a>
    </div>
  </div>

</footer>


  </body>

</html>
