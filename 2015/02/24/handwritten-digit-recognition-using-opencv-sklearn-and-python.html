<!DOCTYPE html>
<html>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58227951-1', 'http://hanzratech.in');
  ga('send', 'pageview');

</script>


  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Digit Recognition using OpenCV, sklearn and Python</title>
    <meta name="description" content="Computer Vision and Programming blog
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://bikz05.github.io/2015/02/24/handwritten-digit-recognition-using-opencv-sklearn-and-python.html">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <!-- <a class="site-title" href="/">Hanzra Tech</a> -->
    <a class="site-title" href="/"><img src="/assets/logo/hanzratech-logo.png" alt="Hanzra Tech" style="width:144px;height:50px"></a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/404.html">404 Error</a>
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/contact/">Contact</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "e95f9855-8c25-452f-a5aa-52401715f9e1", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <h1 class="post-title">Digit Recognition using OpenCV, sklearn and Python</h1>
    <p class="post-meta">Feb 24, 2015 • Bikramjot Singh Hanzra</p>
  </header>

  <article class="post-content">
    <p>Last week, I needed to mail some stuff to one of my friends who recently moved to a new city. So, I called him to inquire about his new address. During the phone call, I quick jotted down the address on a piece of paper and then we took an expected discourse on topics running the entire gamut from movies to politics. After finishing the telephonic conversation, when I gazed at the address that I wrote, it took me a while to understand my own handwriting. I still vividly remember when I was in high school, my mathematics teacher gave me a zero in one of the problems in the test, simply because she was unable to decipher my oracular calligraphy :) , quite an oxymoron . Those were really tough times! Subsequently, I thought about training a classifier to recognize my handwriting. After a couple of days piecemeal work, I was able to recognize my handwriting. Although, I did not do a quantitative analysis of the results, they were all but satisfactory. This motivated me to write a blog post on detecting handwritten digits using HOG features and a multiclass Linear SVM.</p>

<p>Before we begin, I will succinctly enumerate the steps that are needed to detect handwritten digits -</p>

<ol>
  <li>Create a database of handwritten digits.</li>
  <li>For each handwritten digit in the database, extract HOG features and train a Linear SVM.</li>
  <li> Use the classifier trained in step 2 to predict digits.</li>
</ol>

<h3 id="mnistdatabase-of-handwritten-digits">MNIST database of handwritten digits</h3>

<p>The first step is to create a database of handwritten digits. We are not going to create a new database but we will use the popular <strong>MNIST database of handwritten digits.</strong> The MNIST database is a set of 70000 samples of handwritten digits where each sample consists of a grayscale image of size 28×28. There are a total of 70,000 samples. We will use sklearn.datasets package to download the MNIST database from <a href="mldata.org">mldata.org</a>. This package makes it convenient to work with toy datasbases, you can check out the documentation of sklearn.datasets <a href="http://scikit-learn.org/stable/datasets/">here</a>.</p>

<p>The size of of MNIST database is about 55.4 MB. Once the database is downloaded, it will be cached locally in your hard drive. On my Linux system, by default it is cached in ~/scikit_learn_data/mldata/mnist-original.mat . Alternatively, you can also set the directory where the database will be downloaded.</p>

<figure id="figure-1"><a href="/figures/mnist-dataset.png"><img src="/figures/mnist-dataset.png" alt="One sample for each handwritten digit in MNSIT database" /></a><figcaption>Figure 1: One sample for each handwritten digit in MNSIT database [<a href="/figures/mnist-dataset.png">PNG</a>]</figcaption></figure>

<p>There are approximate 7000 samples for each digit. I actually calculated the number of samples for each digit using collections.Counter class. The actual samples for each digit was -</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Digits</th>
      <th style="text-align: center">Number of samples</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">6903</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">7877</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">6990</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">7141</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">6824</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center">6313</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center">6876</td>
    </tr>
    <tr>
      <td style="text-align: center">7</td>
      <td style="text-align: center">7293</td>
    </tr>
    <tr>
      <td style="text-align: center">8</td>
      <td style="text-align: center">6825</td>
    </tr>
    <tr>
      <td style="text-align: center">9</td>
      <td style="text-align: center">6958</td>
    </tr>
  </tbody>
</table>

<p>We will write 2 python scripts – one for training the classifier and the second for test the classifier.</p>

<h3 id="training-a-classifier">Training a Classifier</h3>

<p>Here, we will implement the following steps –</p>

<ol>
  <li>Calculate the HOG features for each sample in the database.</li>
  <li>Train a multi-class linear SVM with the HOG features of each sample along with the corresponding label.</li>
  <li>Save the classifier in a file</li>
</ol>

<p>The first step is to import the required modules –</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="c"># Import the modules</span>
<span class="lineno">2</span> <span class="kn">from</span> <span class="nn">sklearn.externals</span> <span class="kn">import</span> <span class="n">joblib</span>
<span class="lineno">3</span> <span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="lineno">4</span> <span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">hog</span>
<span class="lineno">5</span> <span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">LinearSVC</span>
<span class="lineno">6</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span></code></pre></div>

<p>We will use the <code>sklearn.externals.joblib</code> package to save the classifier in a file so that we can use the classifier again without performing training each time. Calculating HOG features for 70000 images is a costly operation, so we will save the classifier in a file and load it whenever we want to use it. As discussed above <code>sklearn.datasets</code> package will be used to download the MNIST database for handwritten digits. We will use <code>skimage.feature.hog</code> class to calculate the HOG features and <code>sklearn.svm.LinearSVC</code> class to perform prediction after training the classifier. We will store our HOG features and labels in numpy arrays. The next step is to download the dataset using the <code>sklearn.datasets.fetch_mldata</code> function. For the first time, it will take some time as 55.4 MB will be downloaded.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fetch_mldata</span><span class="p">(</span><span class="s">&quot;MNIST Original&quot;</span><span class="p">)</span></code></pre></div>

<p>Once, the dataset is downloaded we will save the images of the digits in a numpy array <code>features</code> and the corresponding labels i.e. the digit in another numpy array <code>labels</code> as shown below –</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;int16&#39;</span><span class="p">)</span> 
<span class="lineno">2</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;int&#39;</span><span class="p">)</span></code></pre></div>

<p>Next, we calculate the HOG features for each image in the database and save them in another numpy array named hog_feature.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">17</span> <span class="n">list_hog_fd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">18</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
<span class="lineno">19</span>     <span class="n">fd</span> <span class="o">=</span> <span class="n">hog</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span> <span class="n">orientations</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">pixels_per_cell</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">cells_per_block</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">visualise</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">20</span>     <span class="n">list_hog_fd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<span class="lineno">21</span> <span class="n">hog_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">list_hog_fd</span><span class="p">,</span> <span class="s">&#39;float64&#39;</span><span class="p">)</span></code></pre></div>

<p>In <strong>line 17</strong> we initialize an empty list <code>list_hog_fd</code>, where we append the HOG features for each sample in the database. So, in the for loop in <strong>line 18</strong>, we calculate the HOG features and append them to the list <code>list_hog_fd</code>. Finally, we create an numpy array <code>hog_features</code> containing the HOG features which will be used to train the classifier. This step will take some time, so be patient while this piece of code finishes.</p>

<p>To calculate the HOG features, we set the number of cells in each block equal to one and each individual cell is of size 14×14. Since our image is of size 28×28, we will have four blocks/cells of size 14×14 each. Also, we set the size of orientation vector equal to 9. So our HOG feature vector for each sample will be of size 4×9 = 36. We are not interesting in visualizing the HOG feature image, so we will set the visualise parameter to false.</p>

<p>If you don’t know about Histogram of Oriented Gaussians (HOG), don’t be disappointed because it is pretty easy to understand. You can check out the below 16 minute <a href="http://www.youtube.com/watch?v=0Zib1YEE4LU">YouTube video</a> by Dr. Mubarak Shah from UCF CRCV. Alternatively, you can check out the documentation of the skimage’s hog function from the <a href="http://scikit-image.org/docs/dev/auto_examples/plot_hog.html">official page</a>. They do discuss tersely about how HOG works.</p>

<p>The next step is to create a Linear SVM object. Since there are 10 digits, we need a multi-class classifier. The Linear SVM that comes with sklearn can perform multi-class classification.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">26</span> <span class="n">clf</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">()</span></code></pre></div>

<p>We preform the training using the fit member function of the <code>clf</code> object.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">29</span> <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hog_features</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span></code></pre></div>

<p>The <code>fit</code> function required 2 arguments –one an array of the HOG features of the handwritten digit that we calculated earlier and a corresponding array of labels. Each label value is from the set — <code>[0, 1, 2, 3,…, 8, 9]</code>. When the training finishes, we will save the classifier in a file named <code>digits_cls.pkl</code> as shown in the code below -</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">32</span> <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="s">&quot;digits_cls.pkl&quot;</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code></pre></div>

<p>The compress parameter in the <code>joblib.dump</code> function is used to set how much compression is done and I am quoting this from the documentation –</p>

<blockquote>
  <p>compress: integer for 0 to 9, optional</p>

  <p>Optional compression level for the data. 0 is no compression. Higher means more compression, but also slower read and write times. Using a value of 3 is often a good compromise.</p>
</blockquote>

<p>Up till this point, we have successfully completed the first task of preparing our classifier.</p>

<h3 id="testing-the-classifier">Testing the Classifier</h3>

<p>Now, we will write another python script to test the classifier. The code for the second script is pretty easy and here is the code for the same –</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="c"># Import the modules</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">cv2</span>
<span class="lineno"> 3</span> <span class="kn">from</span> <span class="nn">sklearn.externals</span> <span class="kn">import</span> <span class="n">joblib</span>
<span class="lineno"> 4</span> <span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">hog</span>
<span class="lineno"> 5</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="c"># Load the classifier</span>
<span class="lineno"> 8</span> <span class="n">clf</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&quot;digits_cls.pkl&quot;</span><span class="p">)</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="c"># Read the input image </span>
<span class="lineno">11</span> <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;/home/bikz05/Desktop/photo8.jpg&quot;</span><span class="p">)</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="c"># Convert to grayscale and apply Gaussian filtering</span>
<span class="lineno">14</span> <span class="n">im_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="lineno">15</span> <span class="n">im_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">im_gray</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">16</span> 
<span class="lineno">17</span> <span class="c"># Threshold the image</span>
<span class="lineno">18</span> <span class="n">ret</span><span class="p">,</span> <span class="n">im_th</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">im_gray</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">)</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="c"># Find contours in the image</span>
<span class="lineno">21</span> <span class="n">ctrs</span><span class="p">,</span> <span class="n">hier</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">im_th</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="c"># Get rectangles contains each contour</span>
<span class="lineno">24</span> <span class="n">rects</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="k">for</span> <span class="n">ctr</span> <span class="ow">in</span> <span class="n">ctrs</span><span class="p">]</span>
<span class="lineno">25</span> 
<span class="lineno">26</span> <span class="c"># For each rectangular region, calculate HOG features and predict</span>
<span class="lineno">27</span> <span class="c"># the digit using Linear SVM.</span>
<span class="lineno">28</span> <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">:</span>
<span class="lineno">29</span>     <span class="c"># Draw the rectangles</span>
<span class="lineno">30</span>     <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> 
<span class="lineno">31</span>     <span class="c"># Make the rectangular region around the digit</span>
<span class="lineno">32</span>     <span class="n">leng</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.6</span><span class="p">)</span>
<span class="lineno">33</span>     <span class="n">pt1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rect</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">leng</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
<span class="lineno">34</span>     <span class="n">pt2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rect</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">leng</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
<span class="lineno">35</span>     <span class="n">roi</span> <span class="o">=</span> <span class="n">im_th</span><span class="p">[</span><span class="n">pt1</span><span class="p">:</span><span class="n">pt1</span><span class="o">+</span><span class="n">leng</span><span class="p">,</span> <span class="n">pt2</span><span class="p">:</span><span class="n">pt2</span><span class="o">+</span><span class="n">leng</span><span class="p">]</span>
<span class="lineno">36</span>     <span class="c"># Resize the image</span>
<span class="lineno">37</span>     <span class="n">roi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
<span class="lineno">38</span>     <span class="n">roi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="lineno">39</span>     <span class="c"># Calculate the HOG features</span>
<span class="lineno">40</span>     <span class="n">roi_hog_fd</span> <span class="o">=</span> <span class="n">hog</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">pixels_per_cell</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="n">cells_per_block</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">visualise</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="lineno">41</span>     <span class="n">nbr</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">roi_hog_fd</span><span class="p">],</span> <span class="s">&#39;float64&#39;</span><span class="p">))</span>
<span class="lineno">42</span>     <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nbr</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="p">(</span><span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_DUPLEX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="lineno">43</span> 
<span class="lineno">44</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&quot;Resulting Image with Rectangular ROIs&quot;</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
<span class="lineno">45</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span></code></pre></div>

<p>From <strong>line 2-5</strong> we load the required modules. In <strong>line 8</strong>, we load the classifier from the file <strong>digits_cls.pkl __which we had saved in the previous script. In __line 11</strong>, we load the test image and in <strong>line 14</strong> we convert it to a grayscale image using <code>cv2.cvtColor</code> function. We then apply a Gaussian filter in <strong>line 15</strong> to the grayscale image to remove noisy pixels. In <strong>line 18</strong>, we convert the grayscale image into a binary image using a threshold value of 90. All the pixel locations with grayscale values greater than 90 are set to 0 in the binary image and all the pixel locations with grayscale values less than 90 are set to 255 in the binary image. In <strong>line 21</strong>, we calculate the contours in the image and then in <strong>line 24</strong> we calculate the bounding box for each contour. From <strong>line 28-35</strong> for each bounding box, we generate a bounding square around each contour. Then in <strong>line 37</strong>, we then resize each bounding square to a size of 28×28 and dilate it in <strong>line 38</strong>. In <strong>line 40</strong>, we calculate the HOG features for each bounding square. Remember here that the HOG feature vector for each bounding square should be of the same size for which the classifier was trained, else you will get an error. In <strong>line 41</strong>, we predict the digit using our classifier. We also draw the bounding box and the predicted digit on the input image. Finally, in <strong>line 44</strong> we display the image.</p>

<p>I tested the classifier on this image -</p>

<figure id="figure-2"><a href="/figures/digit-reco-1-in.jpg"><img src="/figures/digit-reco-1-in.jpg" alt="Input Image" /></a><figcaption>Figure 2: Input Image [<a href="/figures/digit-reco-1-in.jpg">JPG</a>]</figcaption></figure>

<p>The resulting image, after running the second script was -</p>

<figure id="figure-3"><a href="/figures/digit-reco-1-out.png"><img src="/figures/digit-reco-1-out.png" alt="Resultant Image" /></a><figcaption>Figure 3: Resultant Image [<a href="/figures/digit-reco-1-out.png">PNG</a>]</figcaption></figure>

<p>So, the results are pretty good.</p>

<p>Here is another result -</p>

<figure id="figure-4"><a href="/figures/digit-reco-2.png"><img src="/figures/digit-reco-2.png" alt="All the digits have been correctly recognized." /></a><figcaption>Figure 4: All the digits have been correctly recognized. [<a href="/figures/digit-reco-2.png">PNG</a>]</figcaption></figure>

<p><em>(Above)</em> In the image on the left hand side, we display the thresholded image with a square around each digit. Each of this square region is then resized to a 28×28 image. After resizing, we calculate the HOG features of this square region and then using these HOG features we predict the digit. In the image on the right hand side, we display the predicted digit for each handwritten sample bounded in the rectangular box.</p>

<h3 id="assumption-during-testing">Assumption during testing</h3>

<p>There are a few assumptions, we have assumed in the testing images –</p>

<ol>
  <li>
    <p>The digits should be sufficiently apart from each other. Otherwise if the digits are too close, they will interfere in the square region around each digit. In this case, we will need to create a new square image and then we need to copy the contour in that square image.</p>
  </li>
  <li>
    <p>For the images which we used in testing,  fixed thresholding worked pretty well. In most real world images, fixed thresholding does not produce good results. In this case, we need to use adaptive thresholding. You can check out <a href="http://hanzratech.in/python/adaptive-thresholding/">this blog post</a> on adaptive thresholding that I wrote some weeks back.</p>
  </li>
  <li>
    <p>In the pre-processing step, we only did Gaussian blurring. In most situations, on the binary image we will need to open and close the image to remove small noise pixels and fill small holes.</p>
  </li>
</ol>

<h3 id="recap">Recap</h3>

<p>In this tutorial, we discussed how we can recognize handwritten digits using OpenCV, sklearn and Python. We trained a Linear SVM with the HOG features of each sample and tested our code on 2 images. So, That’s it for now!! I hope you liked this blog post.</p>

<p><em>Thank You</em></p>

<h3 id="download-the-code">Download the code</h3>

<p><a href="http://bit.ly/1NXUZAY">Click here</a>
 </p>

  </article>
  
  <center>
<span class='st__large' displayText=''></span>
<span class='st_facebook_large' displayText='Facebook'></span>
<span class='st_googleplus_large' displayText='Google +'></span>
<span class='st_twitter_large' displayText='Tweet'></span>
<span class='st_evernote_large' displayText='Evernote'></span>
<span class='st_tumblr_large' displayText='Tumblr'></span>
<span class='st_baidu_large' displayText='Baidu'></span>
<span class='st_linkedin_large' displayText='LinkedIn'></span>
<span class='st_pinterest_large' displayText='Pinterest'></span>
<span class='st_email_large' displayText='Email'></span>
</center>


  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'hanzratech'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <!-- <h2 class="footer-heading">Hanzra Tech</h2> -->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
	<h3>Hanzra Tech</h3>
        <ul class="contact-list">
	  <li>Bikramjot Singh Hanzra</li>
          <li><a href="mailto:bikz.05@gmail.com">bikz.05@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2" style="text-align: center">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bikz05">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">bikz05</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/bikz05">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">bikz05</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
	<h3>Subscribe to our mailing list</h3>
	<!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/classic-081711.css" rel="stylesheet" type="text/css">
<style type="text/css">
	#mc_embed_signup{clear:left; font:14px Helvetica,Arial,sans-serif; }
	/* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="//hanzratech.us10.list-manage.com/subscribe/post?u=a52f12efb0d1b0d41d887206e&amp;id=647ba168eb" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<!-- <h2>Subscribe to our mailing list</h2> -->
<!-- <div class="indicates-required"><span class="asterisk">*</span> indicates required</div> -->
<div class="mc-field-group">
	<label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
</label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
</div>
	<div id="mce-responses" class="clear">
		<div class="response" id="mce-error-response" style="display:none"></div>
		<div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_a52f12efb0d1b0d41d887206e_647ba168eb" tabindex="-1" value=""></div>
    <div class="clear" ><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>
<script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<!--End mc_embed_signup-->

        <!-- <p class="text">Computer Vision and Programming blog
</p> -->
      </div>
    </div>

    <div style="text-align: center">
    Computer Vision and Programming Blog <br>
    Copyright &#169 2014 All rights reserved <a href="/">Hanzra Tech</a>
    </div>
  </div>

</footer>


  </body>

</html>
